# Исправления проблем с настройками и масштабом

## Последние исправления (текущая сессия):

### 1. Исправлен макет видео для одного участника
**Проблема:** Когда пользователь один в комнате, его видео занимало маленькую область в углу, а большая часть экрана пустовала

**Исправление:**
- Улучшен CSS для макета `layout-1` - теперь видео занимает центральную область размером 60vh
- Добавлено центрирование контента в video-container
- Улучшена адаптивность для разных размеров экрана
- Добавлены минимальные размеры для видео элементов
- Создан тестовый файл `test-layout.html` для проверки макетов

### 2. Полностью переработана система обработчиков событий настроек
**Проблема:** Inline onclick обработчики в HTML не работали надежно, зависели от глобального объекта window.app

**Исправление:**
- Удалены все inline onclick/onchange обработчики из HTML
- Добавлен новый метод `initSettingsEventListeners()` который инициализирует все обработчики при загрузке
- Все обработчики теперь добавляются через addEventListener в JavaScript
- Добавлен метод `closeSettingsModal()` для правильного закрытия модального окна
- Добавлена поддержка закрытия по Escape

### 3. Улучшен масштаб интерфейса
**Проблема:** Масштаб применялся некорректно, отсутствовал класс для 100%

**Исправление:**
- Добавлен класс `ui-scale-100` для нормального масштаба
- Улучшена логика применения масштаба с проверкой поддержки CSS zoom
- Добавлено уведомление при изменении масштаба
- Улучшено логирование для отладки
- Исправлена CSS для всех вариантов масштаба

### 4. Исправлена работа вкладок настроек
**Проблема:** Вкладки не переключались из-за отсутствия обработчиков

**Исправление:**
- Добавлены обработчики для всех кнопок вкладок через addEventListener
- Улучшено логирование переключения вкладок
- Добавлены проверки существования элементов

### 5. Исправлена работа виртуальных фонов
**Проблема:** Обработчики не срабатывали

**Исправление:**
- Добавлен обработчик для select виртуального фона
- Добавлен обработчик для загрузки пользовательского фона
- Логика открытия file input перенесена в JavaScript

## Предыдущие исправления:

### 1. Настройки не работали
**Причина:** Обработчики событий для элементов настроек не были добавлены в `initEventListeners()`

**Исправление:**
- Добавлены обработчики для всех элементов настроек
- Добавлены проверки на существование элементов перед добавлением обработчиков
- Добавлен метод `initSettingsHandlers()` для инициализации обработчиков модального окна

### 2. Масштаб интерфейса работал странно
**Причина:** Использовался `transform: scale()` без компенсации размеров, что приводило к обрезанию контента

**Исправление:**
- Заменен на `zoom` для современных браузеров
- Добавлен fallback с `transform: scale()` и компенсацией размеров для старых браузеров
- Исправлены классы масштабирования: `ui-scale-80`, `ui-scale-120`, `ui-scale-140`
- Добавлен метод `loadUIScale()` для загрузки сохраненного масштаба при запуске

### 3. Вкладки настроек не переключались
**Причина:** Отсутствовали проверки на существование элементов

**Исправление:**
- Добавлены проверки в метод `switchSettingsTab()`
- Добавлено логирование для отладки
- Улучшены стили для вкладок

## Как проверить исправления:

### Проверка макета видео:
1. Откройте приложение и войдите в комнату
2. Ваше видео должно занимать центральную область экрана (примерно 60% высоты)
3. Видео должно быть хорошо видно и не "потеряно" в углу
4. При добавлении участников макет должен автоматически перестраиваться
5. Для тестирования откройте `test-layout.html` в браузере

### Проверка настроек:
1. Откройте приложение
2. Нажмите на кнопку ⚙️ (Настройки)
3. Переключайтесь между вкладками - они должны работать плавно
4. Измените любую настройку
5. Нажмите "Применить"
6. Проверьте консоль браузера (F12) - должны быть логи:
   ```
   Применение настроек...
   Настройки: {...}
   Настройки сохранены: {...}
   ```

### Проверка масштаба:
1. Откройте настройки → вкладка "Внешний вид"
2. Измените "Масштаб интерфейса"
3. Интерфейс должен сразу изменить размер (без нажатия "Применить")
4. Должно появиться уведомление "Масштаб интерфейса: X%"
5. Обновите страницу - масштаб должен сохраниться

### Проверка виртуального фона:
1. Откройте настройки → вкладка "Внешний вид"
2. Выберите "Виртуальный фон" → "Размытие"
3. Фон должен примениться сразу (без нажатия "Применить")
4. Ваше видео должно стать размытым

### Проверка вкладок:
1. Откройте настройки
2. Кликните на каждую вкладку: Устройства, Качество, Звук, Внешний вид
3. Каждая вкладка должна открываться с плавной анимацией
4. В консоли должны быть логи: "Переключение на вкладку: X"

## Отладка:

Если настройки все еще не работают, откройте консоль браузера (F12) и проверьте:

1. **Ошибки JavaScript** - красные сообщения об ошибках
2. **Логи загрузки настроек:**
   ```
   Загрузка настроек...
   Загруженные настройки: {...}
   ```
3. **Логи применения настроек:**
   ```
   Применение настроек...
   Настройки: {...}
   Применен масштаб: 1.2
   ```
4. **Логи переключения вкладок:**
   ```
   Переключение на вкладку: devices
   Кнопка вкладки devices активирована
   Панель вкладки devices активирована
   ```
5. **Логи макета:**
   ```
   Обновление макета для 1 участников
   Применен макет для 1 участника
   ```

## Технические детали:

### Архитектура макетов видео:
- `layout-1`: Один участник - видео занимает 60vh в центре экрана
- `layout-2`: Два участника - сетка 1x2, каждое видео 50vh
- `layout-3-4`: 3-4 участника - сетка 2x2, каждое видео 40vh
- `layout-5-6`: 5-6 участников - сетка 3x2, каждое видео 35vh
- Адаптивность: на мобильных все видео в одну колонку

### Архитектура обработчиков событий:
- Все обработчики инициализируются в `initEventListeners()` при создании WindowManager
- Обработчики настроек выделены в отдельный метод `initSettingsEventListeners()`
- Используется делегирование событий где возможно
- Все обработчики проверяют существование элементов перед добавлением

### Масштабирование:
- Основной метод: CSS `zoom` (поддерживается всеми современными браузерами)
- Fallback: CSS `transform: scale()` с компенсацией размеров
- Классы: `ui-scale-80`, `ui-scale-100`, `ui-scale-120`, `ui-scale-140`
- Сохранение в localStorage: `nearsap-ui-scale`

### Виртуальные фоны:
- `none`: убирает все эффекты
- `blur`: применяет CSS filter blur
- `office`, `nature`, `space`: применяет градиентные фоны
- `custom`: открывает file input для загрузки изображения

## Файлы для тестирования:

- `test-layout.html` - тестирование макетов видео
- `test-settings.html` - тестирование функций настроек

## Известные ограничения:

1. **Виртуальный фон** - пока работает только размытие и простые градиентные фоны
2. **Масштаб** - в некоторых старых браузерах может работать некорректно
3. **Настройки видео** - требуют перезапуска потока для применения

## Следующие шаги:

Для полноценной работы виртуальных фонов потребуется:
- Интеграция с Canvas API для обработки видео
- Возможно, использование библиотеки для сегментации (например, BodyPix или MediaPipe)
- Загрузка и применение пользовательских изображений фонов с правильной обработкой