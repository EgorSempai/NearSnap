#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è Linux/Mac

echo "üåê –ó–∞–ø—É—Å–∫ —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è NearSap..."
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3000..."
if ! lsof -i :3000 >/dev/null 2>&1; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000"
    echo "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞: npm start"
    echo
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000"
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º DNS
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º DNS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."
if ! ping -c 1 1.1.1.1 >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º"
    echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
    echo
fi

echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ 1: Cloudflare Tunnel (—Å DNS –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π)"
echo "üåê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º DNS –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏..."
export TUNNEL_DNS=1.1.1.1
if npx cloudflared tunnel --url http://localhost:3000 --region auto --retries 2 --edge-ip-version 4; then
    exit 0
fi

echo
echo "‚ùå Cloudflare Tunnel –Ω–µ —É–¥–∞–ª—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ DNS –ø—Ä–æ–±–ª–µ–º–∞)"
echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å DNS –Ω–∞ 1.1.1.1 –∏–ª–∏ 8.8.8.8"
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º ngrok
if command -v ngrok &> /dev/null; then
    echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ 2: Ngrok"
    ngrok http 3000
elif command -v lt &> /dev/null; then
    echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ 3: LocalTunnel (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
    lt --port 3000 --subdomain "nearsap-$(date +%s)"
else
    echo "‚ùå ngrok –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo
    echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ 3: LocalTunnel"
    npx localtunnel --port 3000 --subdomain "nearsap-$(date +%s)"
    
    if [ $? -ne 0 ]; then
        echo
        echo "‚ùå –í—Å–µ —Ç—É–Ω–Ω–µ–ª–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å"
        echo
        echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:"
        echo "   1. –ò–∑–º–µ–Ω–∏—Ç–µ DNS –Ω–∞ 1.1.1.1 –∏–ª–∏ 8.8.8.8"
        echo "   2. –û—Ç–∫–ª—é—á–∏—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª –≤—Ä–µ–º–µ–Ω–Ω–æ"
        echo "   3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok: npm install -g ngrok"
        echo "   4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ VPN –µ—Å–ª–∏ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–µ—Ç–∏"
        echo "   5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç"
        echo
    fi
fi