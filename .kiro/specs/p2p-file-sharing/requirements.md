# Requirements Document

## Introduction

P2P передача файлов для NearSap - система прямой передачи файлов между участниками видеочата через WebRTC Data Channel. Позволяет пользователям отправлять файлы любого размера напрямую друг другу, минуя сервер.

## Glossary

- **P2P_File_Transfer**: Система прямой передачи файлов между участниками
- **Data_Channel**: WebRTC канал для передачи данных между пирами
- **File_Sender**: Участник, отправляющий файл
- **File_Receiver**: Участник, получающий файл
- **Drag_Drop_Zone**: Область на видео участника для перетаскивания файлов
- **Transfer_Progress**: Индикатор прогресса передачи файла
- **File_Chunk**: Фрагмент файла для передачи (максимум 64KB)

## Requirements

### Requirement 1: Инициация передачи файлов

**User Story:** Как пользователь, я хочу отправить файл другому участнику, перетащив его на видео этого участника, чтобы быстро поделиться контентом.

#### Acceptance Criteria

1. WHEN пользователь перетаскивает файл на видео другого участника, THEN система SHALL показать визуальную подсветку зоны drop
2. WHEN файл отпущен на видео участника, THEN система SHALL запросить подтверждение отправки с информацией о файле
3. WHEN пользователь подтверждает отправку, THEN система SHALL инициировать P2P соединение через Data Channel
4. WHEN файл больше 100MB, THEN система SHALL показать предупреждение о размере файла
5. WHEN получатель не в сети или недоступен, THEN система SHALL показать ошибку "Участник недоступен для передачи файлов"

### Requirement 2: Установка P2P соединения

**User Story:** Как система, я хочу установить прямое соединение между участниками для передачи файлов, чтобы обеспечить быструю и безопасную передачу.

#### Acceptance Criteria

1. WHEN инициируется передача файла, THEN система SHALL создать WebRTC Data Channel между отправителем и получателем
2. WHEN Data Channel установлен, THEN система SHALL отправить метаданные файла (имя, размер, тип)
3. WHEN получатель получает запрос на передачу, THEN система SHALL показать уведомление с возможностью принять или отклонить
4. WHEN получатель принимает файл, THEN система SHALL начать передачу данных
5. WHEN получатель отклоняет файл, THEN система SHALL уведомить отправителя об отказе

### Requirement 3: Передача файла по частям

**User Story:** Как система, я хочу передавать файлы по небольшим частям, чтобы обеспечить стабильность передачи и возможность показа прогресса.

#### Acceptance Criteria

1. WHEN начинается передача файла, THEN система SHALL разделить файл на части размером максимум 64KB
2. WHEN передается каждая часть, THEN система SHALL отправить номер части и контрольную сумму
3. WHEN получена каждая часть, THEN система SHALL проверить целостность и отправить подтверждение
4. WHEN все части переданы, THEN система SHALL собрать файл и проверить общую контрольную сумму
5. WHEN обнаружена ошибка в части, THEN система SHALL запросить повторную передачу этой части

### Requirement 4: Индикация прогресса передачи

**User Story:** Как пользователь, я хочу видеть прогресс передачи файла, чтобы понимать, сколько времени осталось до завершения.

#### Acceptance Criteria

1. WHEN начинается передача файла, THEN система SHALL показать прогресс-бар на видео отправителя и получателя
2. WHEN передается каждая часть файла, THEN система SHALL обновлять процент выполнения
3. WHEN передача завершена успешно, THEN система SHALL показать уведомление "Файл отправлен/получен"
4. WHEN передача прервана, THEN система SHALL показать возможность возобновить передачу
5. WHEN оценивается скорость передачи, THEN система SHALL показать примерное время до завершения

### Requirement 5: Управление передачами

**User Story:** Как пользователь, я хочу управлять активными передачами файлов, чтобы иметь контроль над процессом.

#### Acceptance Criteria

1. WHEN активна передача файла, THEN система SHALL показать кнопку отмены передачи
2. WHEN пользователь отменяет передачу, THEN система SHALL остановить передачу и уведомить другую сторону
3. WHEN передача прервана по сети, THEN система SHALL предложить возобновить передачу
4. WHEN одновременно передается несколько файлов, THEN система SHALL показать список активных передач
5. WHEN файл успешно передан, THEN система SHALL автоматически предложить открыть папку с файлом

### Requirement 6: Безопасность и ограничения

**User Story:** Как администратор системы, я хочу обеспечить безопасность передачи файлов, чтобы предотвратить передачу вредоносного контента.

#### Acceptance Criteria

1. WHEN передается файл, THEN система SHALL проверить расширение файла против списка запрещенных (.exe, .bat, .scr)
2. WHEN файл больше 2GB, THEN система SHALL отклонить передачу с сообщением о превышении лимита
3. WHEN обнаружен подозрительный файл, THEN система SHALL показать предупреждение получателю
4. WHEN пользователь получает файл, THEN система SHALL сохранить его в папку Downloads с префиксом "NearSap_"
5. WHEN включен режим "Только изображения", THEN система SHALL принимать только файлы изображений

### Requirement 7: Интеграция с интерфейсом

**User Story:** Как пользователь, я хочу интуитивно понятный интерфейс для передачи файлов, чтобы легко делиться контентом.

#### Acceptance Criteria

1. WHEN пользователь наводит файл на видео участника, THEN система SHALL показать подсветку и текст "Отправить файл [Имя участника]"
2. WHEN активна передача файла, THEN система SHALL показать мини-индикатор прогресса поверх видео
3. WHEN файл получен, THEN система SHALL показать уведомление с именем файла и кнопкой "Открыть"
4. WHEN в настройках включено "Автоматически принимать файлы", THEN система SHALL принимать файлы без подтверждения
5. WHEN пользователь кликает на кнопку "Отправить файл" в контекстном меню, THEN система SHALL открыть диалог выбора файла

### Requirement 8: Обработка ошибок и восстановление

**User Story:** Как пользователь, я хочу, чтобы система корректно обрабатывала ошибки передачи, чтобы не терять файлы при сбоях.

#### Acceptance Criteria

1. WHEN соединение прервано во время передачи, THEN система SHALL сохранить прогресс и предложить возобновить
2. WHEN получатель закрыл браузер во время передачи, THEN система SHALL уведомить отправителя о прерывании
3. WHEN не хватает места на диске получателя, THEN система SHALL показать ошибку "Недостаточно места для сохранения файла"
4. WHEN файл поврежден при передаче, THEN система SHALL автоматически запросить повторную передачу
5. WHEN превышено время ожидания ответа, THEN система SHALL показать ошибку "Тайм-аут передачи файла"